import React, { useState, useEffect } from 'react';
import { authService } from '../../../services/authService';
import GenericDataTable from '../../../components/GenericDataTable';
import PathologyForm from './components/PathologyForm';
import PathologyView from './components/PathologyView';
import './Pathology.css';

const Pathology = () => {
  const [reports, setReports] = useState([]);
  const [filteredReports, setFilteredReports] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [currentPage, setCurrentPage] = useState(0);
  const [statusFilter, setStatusFilter] = useState('All');
  const [selectedReport, setSelectedReport] = useState(null);
  const [showForm, setShowForm] = useState(false);
  const [showView, setShowView] = useState(false);

  const itemsPerPage = 20;

  useEffect(() => {
    fetchReports();
  }, []);

  useEffect(() => {
    filterReports();
  }, [reports, searchQuery, statusFilter]);

  const fetchReports = async () => {
    setIsLoading(true);
    try {
      const response = await authService.get('/pathology-reports');
      const reportsData = response.data || response;
      const reportsList = Array.isArray(reportsData) ? reportsData : [];
      
      const mappedReports = reportsList.map(r => ({
        id: r._id || r.reportId || r.id,
        reportId: r._id || r.reportId || '',
        patientName: r.patientName || 'Unknown',
        patientCode: r.patientCode || 'PAT-00',
        testName: r.testType || r.testName || 'N/A',
        collectionDate: r.createdAt || r.collectionDate || '',
        status: r.fileRef ? 'Completed' : 'Pending',
        uploaderName: r.uploaderName || 'Admin',
        fileRef: r.fileRef || null,
        rawData: r
      }));

      setReports(mappedReports);
    } catch (error) {
      console.error('Failed to fetch pathology reports:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const filterReports = () => {
    const q = searchQuery.toLowerCase().trim();
    let filtered = reports;

    if (q) {
      filtered = filtered.filter(r =>
        r.patientName.toLowerCase().includes(q) ||
        r.patientCode.toLowerCase().includes(q) ||
        r.testName.toLowerCase().includes(q) ||
        r.reportId.toLowerCase().includes(q)
      );
    }

    if (statusFilter !== 'All') {
      filtered = filtered.filter(r => r.status === statusFilter);
    }

    setFilteredReports(filtered);
    setCurrentPage(0);
  };

  const handleSearchChange = (value) => {
    setSearchQuery(value);
  };

  const handleAddReport = () => {
    setSelectedReport(null);
    setShowForm(true);
  };

  const handleEditReport = (report) => {
    setSelectedReport(report.rawData);
    setShowForm(true);
  };

  const handleViewReport = (report) => {
    setSelectedReport(report.rawData);
    setShowView(true);
  };

  const handleDeleteReport = async (report) => {
    if (!window.confirm(`Are you sure you want to delete this report?`)) return;
    
    try {
      await authService.delete(`/pathology-reports/${report.id}`);
      await fetchReports();
      alert('Report deleted successfully');
    } catch (error) {
      console.error('Failed to delete report:', error);
      alert('Failed to delete report');
    }
  };

  const handleFormClose = (shouldRefresh) => {
    setShowForm(false);
    setSelectedReport(null);
    if (shouldRefresh) {
      fetchReports();
    }
  };

  const handleViewClose = () => {
    setShowView(false);
    setSelectedReport(null);
  };

  const handleDownloadReport = async (report) => {
    if (!report.fileRef) {
      alert('No file attached to this report');
      return;
    }

    try {
      window.open(report.fileRef, '_blank');
    } catch (error) {
      console.error('Failed to download report:', error);
      alert('Failed to download report');
    }
  };

  const columns = [
    { key: 'reportId', label: 'Report ID', sortable: true },
    { key: 'patientName', label: 'Patient', sortable: true },
    { key: 'patientCode', label: 'Patient Code', sortable: true },
    { key: 'testName', label: 'Test Type', sortable: true },
    { key: 'collectionDate', label: 'Date', sortable: true },
    { key: 'status', label: 'Status', sortable: true },
    { key: 'uploaderName', label: 'Uploaded By', sortable: true },
  ];

  const uniqueStatuses = ['All', 'Pending', 'Completed'];

  return (
    <div className="pathology-page">
      <div className="page-header">
        <div className="header-content">
          <div className="header-text">
            <h1 className="page-title">
              <span className="icon">ðŸ”¬</span>
              Pathology Reports
            </h1>
            <p className="page-subtitle">Manage lab test reports and results</p>
          </div>
          <button className="btn-primary" onClick={handleAddReport}>
            <span className="icon">âž•</span>
            Upload Report
          </button>
        </div>
      </div>

      <div className="filter-section">
        <div className="search-box">
          <input
            type="text"
            placeholder="Search reports..."
            value={searchQuery}
            onChange={(e) => handleSearchChange(e.target.value)}
            className="search-input"
          />
        </div>
        <div className="filter-group">
          <label>Status:</label>
          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="filter-select"
          >
            {uniqueStatuses.map(status => (
              <option key={status} value={status}>{status}</option>
            ))}
          </select>
        </div>
      </div>

      <GenericDataTable
        columns={columns}
        data={filteredReports}
        isLoading={isLoading}
        currentPage={currentPage}
        itemsPerPage={itemsPerPage}
        onPageChange={setCurrentPage}
        onView={handleViewReport}
        onEdit={handleEditReport}
        onDelete={handleDeleteReport}
        customActions={(report) => (
          report.fileRef && (
            <button
              className="action-btn download-btn"
              onClick={() => handleDownloadReport(report)}
              title="Download Report"
            >
              ðŸ“¥
            </button>
          )
        )}
      />

      {showForm && (
        <PathologyForm
          report={selectedReport}
          onClose={handleFormClose}
        />
      )}

      {showView && selectedReport && (
        <PathologyView
          report={selectedReport}
          onClose={handleViewClose}
        />
      )}
    </div>
  );
};

export default Pathology;
